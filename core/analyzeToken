// FILE: core/analyzeToken.js
const pino = require('pino');

const logger = pino({
  name: 'TokenAnalyzer',
  level: process.env.LOG_LEVEL || 'info',
});

/**
 * Analyze a token pair to see if it meets liquidity, volume, and age thresholds
 * @param {Object} pair - The token pair object from scanner
 * @returns {Object|boolean} Returns token info object if valid, otherwise false
 */
async function analyzeToken(pair) {
  try {
    if (!pair || !pair.baseToken) {
      logger.warn('Invalid pair object', { pair });
      return false;
    }

    const liq = pair.liquidity?.usd || 0;
    const vol = pair.volume?.h24 || 0;
    const createdAt = pair.pairCreatedAt || Date.now();
    const ageMins = (Date.now() - createdAt) / 60000;

    // Apply thresholds
    if (liq < 25000) {
      logger.info(`Liquidity too low: $${liq}`);
      return false;
    }
    if (vol < 10000) {
      logger.info(`Volume too low: $${vol}`);
      return false;
    }
    if (ageMins > 120) {
      logger.info(`Token too old: ${Math.floor(ageMins)} minutes`);
      return false;
    }

    // Build token signal object
    const tokenData = {
      token: pair.baseToken.name,
      symbol: pair.baseToken.symbol,
      address: pair.baseToken.address,
      price: pair.priceUsd || 0,
      liquidity: liq,
      volume: vol,
      age: `${Math.floor(ageMins)}m`,
      url: pair.url || ''
    };

    logger.info(`Token passed analysis: ${tokenData.token} (${tokenData.symbol})`);
    return tokenData;

  } catch (e) {
    logger.error({ e }, 'Error analyzing token pair');
    return false;
  }
}

module.exports = { analyzeToken };
